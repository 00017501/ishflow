name: "ishflow_api_service"

x-base-api: &base-api
  build:
    context: ../../
    dockerfile: docker/images/prod/api.Dockerfile
  working_dir: /app
  env_file:
    - ../../.env
  volumes:
    - ../../src:/app/src
    - ../../public:/app/public
    - ../../Makefile:/app/Makefile
    - ../../manage.py:/app/manage.py
    - ../../uv.lock:/app/uv.lock
    - ../../pyproject.toml:/app/pyproject.toml
  networks:
    - ishflow_network

services:
  api:
    <<: *base-api
    container_name: api-service
    command: ["make", "run_server_prod"]
    restart: always
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "python", "manage.py", "check", "--deploy"]
      interval: 30s
      timeout: 10s
      retries: 5

  nginx:
    image: nginx:alpine
    container_name: nginx-service
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../../docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../../docker/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../docker/nginx/conf.d/default-https.conf:/etc/nginx/conf.d/https.conf.template:ro
      - certbot_www:/var/www/certbot:ro
      - certbot_conf:/etc/letsencrypt:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      - api
      - minio
    networks:
      - ishflow_network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  certbot:
    image: certbot/certbot:latest
    container_name: certbot-service
    volumes:
      - certbot_www:/var/www/certbot:rw
      - certbot_conf:/etc/letsencrypt:rw
      - ../../docker/entrypoints/prod/certbot.sh:/entrypoint.sh:ro
    entrypoint: ["/bin/sh", "/entrypoint.sh"]
    depends_on:
      nginx:
        condition: service_healthy
    networks:
      - ishflow_network

  minio:
    image: minio/minio:RELEASE.2023-03-24T21-41-23Z
    container_name: minio-service
    env_file:
      - ../../.env
    expose:
      - "9000"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-ishflow}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-ishflow123}
      MINIO_BROWSER: "off"
    volumes:
      - minio_data:/data
    networks:
      - ishflow_network
    command: server /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  createbuckets:
    image: minio/mc:RELEASE.2023-03-23T20-03-04Z
    depends_on:
      minio:
        condition: service_healthy
    env_file:
      - ../../.env
    networks:
      - ishflow_network
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER:-ishflow} ${MINIO_ROOT_PASSWORD:-ishflow123};
      /usr/bin/mc mb myminio/media --ignore-existing;
      /usr/bin/mc mb myminio/static --ignore-existing;
      /usr/bin/mc anonymous set download myminio/media;
      /usr/bin/mc anonymous set download myminio/static;
      exit 0;
      "

networks:
  ishflow_network:
    driver: bridge

volumes:
  minio_data:
  nginx_cache:
  nginx_logs:
  certbot_www:
  certbot_conf:
